networks:
    ai_diary_network:
        driver: bridge

services:
    # ----------------------------------------------------
    # 1. Laravelアプリケーションコンテナ (php-fpm)
    # ----------------------------------------------------
    app:
        build:
            context: .
            dockerfile: Dockerfile
        image: laravel-app
        container_name: ai_diary_app
        restart: always
        networks:
            - ai_diary_network
        volumes:
            - ../web-app:/var/www/html
        # 【変更】8080ポートはreverbサービスに移動するため削除
        ports:
            - '5173:5173'
        environment:
            DB_CONNECTION: mysql
            DB_HOST: db
            DB_PORT: 3306
            DB_DATABASE: ai_diary_db
            DB_USERNAME: user
            DB_PASSWORD: password
            REDIS_HOST: redis
            QUEUE_CONNECTION: redis
            APP_ENV: local
            APP_DEBUG: 'true'
            APP_URL: http://localhost
            TZ: 'Asia/Tokyo'
            # Reverb設定
            BROADCAST_CONNECTION: reverb
            REVERB_APP_ID: app_id
            REVERB_APP_KEY: app_key
            REVERB_APP_SECRET: app_secret
            REVERB_HOST: "0.0.0.0"
            REVERB_PORT: 8080
            REVERB_SCHEME: http
        healthcheck:
            test: ["CMD-SHELL", "php-fpm -t || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_started

    # ----------------------------------------------------
    # 2. Nginx Webサーバーコンテナ
    # ----------------------------------------------------
    nginx:
        image: nginx:stable-alpine
        container_name: ai_diary_nginx
        restart: always
        networks:
            - ai_diary_network
        volumes:
            - ../web-app:/var/www/html
            - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
        ports:
            - '80:80'
        healthcheck:
            test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:80/up || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        depends_on:
            app:
                condition: service_healthy

    # ----------------------------------------------------
    # 3. MySQLデータベースコンテナ
    # ----------------------------------------------------
    db:
        image: mysql/mysql-server:8.0
        container_name: ai_diary_db
        restart: always
        networks:
            - ai_diary_network
        environment:
            MYSQL_ROOT_PASSWORD: root_password
            MYSQL_DATABASE: ai_diary_db
            MYSQL_USER: user
            MYSQL_PASSWORD: password
            TZ: 'Asia/Tokyo'
        ports:
            - '3306:3306'
        volumes:
            - db_data:/var/lib/mysql
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "user", "-ppassword"]
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 30s

    # ----------------------------------------------------
    # 4. Redisコンテナ
    # ----------------------------------------------------
    redis:
        image: redis:alpine
        container_name: ai_diary_redis
        restart: always
        networks:
            - ai_diary_network
        volumes:
            - redis_data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    # ----------------------------------------------------
    # 5. Laravel Queue Worker コンテナ
    # ----------------------------------------------------
    queue:
        build:
            context: .
            dockerfile: Dockerfile
        image: laravel-worker
        container_name: ai_diary_queue_worker
        restart: always
        networks:
            - ai_diary_network
        volumes:
            - ../web-app:/var/www/html
        environment:
            DB_CONNECTION: mysql
            DB_HOST: db
            DB_PORT: 3306
            DB_DATABASE: ai_diary_db
            DB_USERNAME: user
            DB_PASSWORD: password
            REDIS_HOST: redis
            QUEUE_CONNECTION: redis
            APP_ENV: local
            TZ: 'Asia/Tokyo'
            # Reverb設定
            BROADCAST_CONNECTION: reverb
            REVERB_APP_ID: app_id
            REVERB_APP_KEY: app_key
            REVERB_APP_SECRET: app_secret
            # ワーカーから見たReverbホストはサービス名の 'reverb'
            REVERB_HOST: reverb 
            REVERB_PORT: 8080
            REVERB_SCHEME: http
        command: php artisan queue:work redis --tries=3 --timeout=60
        depends_on:
            app:
                condition: service_healthy
            redis:
                condition: service_healthy
            db:
                condition: service_healthy

    # ----------------------------------------------------
    # 6. Laravel Reverb Server (WebSocket) 【追加】
    # ----------------------------------------------------
    reverb:
        build:
            context: .
            dockerfile: Dockerfile
        image: laravel-reverb
        container_name: ai_diary_reverb
        restart: always
        networks:
            - ai_diary_network
        volumes:
            - ../web-app:/var/www/html
        environment:
            DB_CONNECTION: mysql
            DB_HOST: db
            DB_PORT: 3306
            DB_DATABASE: ai_diary_db
            DB_USERNAME: user
            DB_PASSWORD: password
            REDIS_HOST: redis
            APP_ENV: local
            TZ: 'Asia/Tokyo'
            # Reverb設定
            BROADCAST_CONNECTION: reverb
            REVERB_APP_ID: app_id
            REVERB_APP_KEY: app_key
            REVERB_APP_SECRET: app_secret
            REVERB_HOST: "0.0.0.0"
            REVERB_PORT: 8080
            REVERB_SCHEME: http
        # 起動コマンド: Reverbサーバーを開始
        command: php artisan reverb:start
        # ポート公開
        ports:
            - '8080:8080'
        depends_on:
            redis:
                condition: service_healthy

volumes:
    db_data:
    redis_data: